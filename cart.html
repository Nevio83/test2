<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warenkorb - Marktplatz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link href="cart.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-shop" aria-hidden="true"></i> Marktplatz
            </a>
            <a href="index.html" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> Zur√ºck zum Shop
            </a>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-cart3" aria-hidden="true"></i> Ihr Warenkorb
            </h1>
            <p class="page-subtitle">√úberpr√ºfen Sie Ihre Artikel und schlie√üen Sie Ihre Bestellung ab</p>
        </div>

        <div id="cartContent">
            <!-- Wird dynamisch gef√ºllt -->
            <button class="checkout-btn" aria-label="Zur Kasse gehen">
                <i class="bi bi-cart-check" aria-hidden="true"></i>
                <span class="checkout-text">Jetzt sicher bezahlen</span>
            </button>
        </div>
    </div>

    <!-- Vorschl√§ge -->
    <div class="container my-5" id="suggestions-container" style="display: none;">
        <div class="row row-cols-1 row-cols-md-2 g-4" id="suggestions-grid">
            <!-- Vorschl√§ge werden hier dynamisch eingef√ºgt -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script src="cart.js"></script>
    <script src="keyboard-shortcuts.js" defer></script>
    
    <!-- NOTFALL-BILDFIX - √úberschreibt cart.js Rendering -->
    <script>
    // √úberschreibe die updateCartPage Funktion falls sie existiert
    const originalUpdateCartPage = window.updateCartPage;
    
    window.updateCartPage = function() {
        console.log('üö® NOTFALL: updateCartPage √ºberschrieben');
        
        // F√ºhre die urspr√ºngliche Funktion aus
        if (originalUpdateCartPage) {
            originalUpdateCartPage();
        }
        
        // Dann sofort Bildfix
        setTimeout(function() {
            forceFixCartImages();
        }, 100);
    };
    
    // MOBILE-ONLY HTML-INJECTION L√ñSUNG
    function forceFixCartImages() {
        // NUR AUF MOBILE GER√ÑTEN AUSF√úHREN
        if (window.innerWidth > 768) {
            console.log('üñ•Ô∏è Desktop erkannt - √ºberspringe Bildfix');
            return;
        }
        
        console.log('üì± Mobile erkannt - starte Bildfix');
        
        // Hole Warenkorb-Daten
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        console.log('üõí Warenkorb-Daten:', cart);
        
        // Finde alle cart-item Elemente
        const cartItems = document.querySelectorAll('.cart-item');
        console.log(`üì¶ Gefundene Cart Items: ${cartItems.length}`);
        
        cartItems.forEach((item, index) => {
            // PR√úFE OB BEREITS EIN FORCED-IMAGE EXISTIERT
            if (item.querySelector('.forced-cart-image, .forced-fallback-image')) {
                console.log(`‚è≠Ô∏è Item ${index} bereits bearbeitet - √ºberspringe`);
                return;
            }
            
            console.log(`üîß Bearbeite Cart Item ${index}`);
            
            // Hole Produktname aus dem Item
            const nameElement = item.querySelector('h5, .cart-item-name, .cart-item-details h5');
            const productName = nameElement ? nameElement.textContent.trim() : '';
            console.log(`üìù Produktname: "${productName}"`);
            
            // Finde passendes Produkt im Warenkorb
            const cartProduct = cart.find(product => 
                product.name === productName || 
                productName.includes(product.name) || 
                product.name.includes(productName)
            );
            
            if (cartProduct && cartProduct.image) {
                console.log(`‚úÖ Produkt gefunden: ${cartProduct.name} -> ${cartProduct.image}`);
                
                // Entferne nur kaputte Bilder, behalte funktionierende
                const brokenImages = item.querySelectorAll('img[src=""], img[src*="undefined"], .cart-item-image-placeholder');
                brokenImages.forEach(img => img.remove());
                
                // Erstelle neues Bild-HTML direkt (NUR MOBILE) - GR√ñSSERE VERSION
                const imageHTML = `
                    <div style="
                        width: 80px !important;
                        height: 80px !important;
                        min-width: 80px !important;
                        min-height: 80px !important;
                        border-radius: 50% !important;
                        background-image: url('${cartProduct.image}') !important;
                        background-size: cover !important;
                        background-position: center !important;
                        background-repeat: no-repeat !important;
                        border: 3px solid #e3e8f0 !important;
                        box-shadow: 0 4px 16px rgba(0,0,0,0.2) !important;
                        margin-right: 1.5rem !important;
                        flex-shrink: 0 !important;
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        position: relative !important;
                        z-index: 10 !important;
                        background-color: #f3f6fa !important;
                    " class="forced-cart-image" data-processed="true"></div>
                `;
                
                // F√ºge das Bild am Anfang des Items ein
                item.insertAdjacentHTML('afterbegin', imageHTML);
                console.log(`üéØ Mobile-Bild eingef√ºgt f√ºr: ${cartProduct.name}`);
                
            } else {
                console.log(`‚ùå Kein Produkt gefunden f√ºr: "${productName}"`);
                
                // Erstelle Fallback-Bild (NUR MOBILE) - GR√ñSSERE VERSION
                const fallbackHTML = `
                    <div style="
                        width: 80px !important;
                        height: 80px !important;
                        min-width: 80px !important;
                        min-height: 80px !important;
                        border-radius: 50% !important;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        border: 3px solid #ffffff !important;
                        margin-right: 1.5rem !important;
                        flex-shrink: 0 !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-size: 2rem !important;
                        color: white !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        position: relative !important;
                        z-index: 10 !important;
                        box-shadow: 0 4px 16px rgba(0,0,0,0.2) !important;
                    " class="forced-fallback-image" data-processed="true">üì∑</div>
                `;
                
                item.insertAdjacentHTML('afterbegin', fallbackHTML);
                console.log(`üîß Mobile-Fallback eingef√ºgt f√ºr: "${productName}"`);
            }
        });
    }
    
    // ULTIMATIVE AUSF√úHRUNG - MEHRFACH UND AGGRESSIV
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM GELADEN - STARTE ULTIMATIVEN BILDFIX');
        
        // Sofort ausf√ºhren
        forceFixCartImages();
        
        // Alle 500ms f√ºr die ersten 5 Sekunden
        let attempts = 0;
        const maxAttempts = 10;
        
        const interval = setInterval(function() {
            attempts++;
            console.log(`üîÑ Bildfix Versuch ${attempts}/${maxAttempts}`);
            forceFixCartImages();
            
            if (attempts >= maxAttempts) {
                clearInterval(interval);
                console.log('‚úÖ Bildfix-Versuche abgeschlossen');
            }
        }, 500);
        
        // √úberwache auch √Ñnderungen am gesamten Body
        const observer = new MutationObserver(function(mutations) {
            let shouldFix = false;
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    for (let node of mutation.addedNodes) {
                        if (node.nodeType === 1 && (
                            node.classList.contains('cart-item') ||
                            node.querySelector('.cart-item') ||
                            node.id === 'cartContent' ||
                            node.id === 'cartItemsList'
                        )) {
                            shouldFix = true;
                            break;
                        }
                    }
                }
            });
            
            if (shouldFix) {
                console.log('üîÑ DOM-√Ñnderung erkannt - f√ºhre Bildfix aus');
                setTimeout(forceFixCartImages, 50);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });
    </script>
    
    <!-- Mobile Bildfix f√ºr Warenkorb -->
    <script>
    // Robuste Bildladefehler-Behandlung f√ºr mobile Ger√§te
    function handleImageError(imgElement, itemName, originalPath) {
        console.log('Bildladefehler f√ºr:', itemName, 'Pfad:', originalPath);
        
        // Liste von Fallback-Strategien
        const fallbackStrategies = [
            // 1. Versuche URL-encoded Version
            originalPath.replace(/ /g, '%20'),
            // 2. Versuche .jpeg statt .jpg
            originalPath.replace('.jpg', '.jpeg'),
            // 3. Versuche .png statt .jpg
            originalPath.replace('.jpg', '.png'),
            // 4. Versuche .webp statt .jpg
            originalPath.replace('.jpg', '.webp'),
            // 5. Fallback zu ware.png
            'produkt bilder/ware.png'
        ];
        
        // Versuche die n√§chste Strategie
        let currentStrategy = imgElement.dataset.strategyIndex || 0;
        currentStrategy = parseInt(currentStrategy) + 1;
        
        if (currentStrategy < fallbackStrategies.length) {
            imgElement.dataset.strategyIndex = currentStrategy;
            const nextPath = fallbackStrategies[currentStrategy];
            console.log(`Versuche Fallback-Strategie ${currentStrategy}:`, nextPath);
            imgElement.src = nextPath;
        } else {
            console.error('Alle Fallback-Strategien fehlgeschlagen f√ºr:', itemName);
            // Als letzter Ausweg: Zeige einen Platzhalter
            imgElement.style.background = '#f8f9fa';
            imgElement.style.border = '2px dashed #dee2e6';
            imgElement.style.display = 'block';
            imgElement.style.width = '80px';
            imgElement.style.height = '80px';
            imgElement.alt = 'Bild nicht verf√ºgbar';
        }
    }
    
    // Mache die Funktion global verf√ºgbar
    window.handleImageError = handleImageError;
    
    // √úberwache √Ñnderungen am cartContent f√ºr dynamisch geladene Inhalte
    function fixCartImages() {
        console.log('üîç Suche nach Warenkorb-Bildern...');
        
        // Suche nach allen cart-item Elementen
        const cartItems = document.querySelectorAll('.cart-item');
        console.log('üì¶ Gefundene Cart Items:', cartItems.length);
        
        cartItems.forEach(function(item, index) {
            console.log('üîß Bearbeite Cart Item', index);
            
            // Suche nach vorhandenen Bildern
            let img = item.querySelector('.cart-item-image, img');
            
            if (!img) {
                console.log('‚ùå Kein Bild gefunden in Item', index, '- erstelle neues');
                // Erstelle ein neues Bild-Element
                img = document.createElement('img');
                img.className = 'cart-item-image';
                img.src = 'produkt bilder/ware.png';
                img.alt = 'Produktbild';
                
                // F√ºge das Bild am Anfang hinzu
                item.insertBefore(img, item.firstChild);
            } else {
                console.log('‚úÖ Bild gefunden in Item', index, '- repariere es');
                
                // Repariere vorhandenes Bild
                if (!img.src || img.src.includes('undefined') || img.src === window.location.href) {
                    console.log('üîß Repariere kaputten Bildpfad');
                    img.src = 'produkt bilder/ware.png';
                }
            }
            
            // Erzwinge korrekte Darstellung - RUNDE BILDER wie bei Add-ons
            img.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 80px !important;
                height: 80px !important;
                object-fit: cover !important;
                object-position: center !important;
                border-radius: 50% !important;
                border: 3px solid #e3e8f0 !important;
                background: #f3f6fa !important;
                flex-shrink: 0 !important;
                margin-right: 1rem !important;
                box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                filter: brightness(1.02) contrast(1.05) saturate(1.08) !important;
            `;
            
            // F√ºge Fehlerbehandlung hinzu
            img.onerror = function() {
                console.log('üö® Bildladefehler, wechsle zu Fallback');
                this.src = 'produkt bilder/ware.png';
            };
        });
    }
    
    // F√ºhre die Reparatur mehrfach aus
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM geladen, starte Bildfix...');
        
        // Sofort ausf√ºhren
        fixCartImages();
        
        // Nach 500ms nochmal
        setTimeout(fixCartImages, 500);
        
        // Nach 1 Sekunde nochmal
        setTimeout(fixCartImages, 1000);
        
        // Nach 2 Sekunden nochmal
        setTimeout(fixCartImages, 2000);
        
        // √úberwache √Ñnderungen am cartContent
        const cartContent = document.getElementById('cartContent');
        if (cartContent) {
            const observer = new MutationObserver(function(mutations) {
                console.log('üîÑ Cart Content ge√§ndert, f√ºhre Bildfix aus');
                setTimeout(fixCartImages, 100);
            });
            
            observer.observe(cartContent, {
                childList: true,
                subtree: true
            });
        }
    });
    </script>
    
    <!-- Warenkorb Farb√§nderungs-System -->
    <script src="cart-color-changer.js"></script>
</body>
</html>