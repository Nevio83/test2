// ============================================
// CART COLOR IMAGES ONLY - Finale Version
// ============================================

console.log("üñºÔ∏è Cart Color Images Only geladen");

async function renderImageColorSelection(item, container) {
  if (!item || !container) return;

  try {
    const response = await fetch("products.json");
    const products = await response.json();
    const product = products.find((p) => p.id === parseInt(item.id));

    if (!product || !product.colors || product.colors.length === 0) return;

    const selectionContainer = document.createElement("div");
    selectionContainer.className = "cart-item-color-selection";
    // Auf gro√üen Bildschirmen Full-bleed aktivieren
    try {
      if (window && window.innerWidth >= 1000) {
        selectionContainer.classList.add("full-bleed");
      }
    } catch (e) {
      // window might not be available in some contexts
    }

    const labelSpan = document.createElement("span");
    labelSpan.className = "cart-color-main-label";
    labelSpan.textContent = "Farbe:";
    selectionContainer.appendChild(labelSpan);

    const optionsContainer = document.createElement("div");
    optionsContainer.className = "cart-color-options-scroll";
    selectionContainer.appendChild(optionsContainer);

    const currentColor =
      extractColorFromName(item.name) || product.colors[0].name;

    product.colors.forEach((color) => {
      const optionDiv = document.createElement("div");
      optionDiv.className = `cart-color-option ${
        color.name === currentColor ? "selected" : ""
      }`;

      const label = document.createElement("label");
      const img = document.createElement("img");
      img.src = getColorSpecificImagePath(product, color.name);
      img.alt = color.name;
      img.className = "cart-color-image";

      const nameSpan = document.createElement("span");
      nameSpan.className = "cart-color-name";
      nameSpan.textContent = color.name;

      label.appendChild(img);
      label.appendChild(nameSpan);
      optionDiv.appendChild(label);
      optionsContainer.appendChild(optionDiv);

      label.addEventListener("click", (e) => {
        e.preventDefault();
        const colorName = color.name;
        optionsContainer
          .querySelectorAll(".cart-color-option")
          .forEach((opt) => opt.classList.remove("selected"));
        optionDiv.classList.add("selected");

        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const itemIndex = cart.findIndex((cartItem) => cartItem.id == item.id);
        if (itemIndex !== -1) {
          const baseName = cart[itemIndex].name.replace(/\s*\([^)]*\)$/, "");
          cart[itemIndex].name = `${baseName} (${colorName})`;
          cart[itemIndex].selectedColor = colorName;
          
          // Aktualisiere Preis basierend auf der gew√§hlten Farbe
          if (color.price) {
            cart[itemIndex].price = color.price;
            console.log(`üí∞ Preis aktualisiert f√ºr ${colorName}: ‚Ç¨${color.price}`);
          }
          
          localStorage.setItem("cart", JSON.stringify(cart));

          const cartItem = container.closest(".cart-item");
          const nameElement = cartItem?.querySelector("h5");
          if (nameElement) nameElement.textContent = cart[itemIndex].name;
          
          // Aktualisiere Preisanzeige im DOM
          if (color.price) {
            const priceElement = cartItem?.querySelector(".cart-item-price, .price, .item-price");
            if (priceElement) {
              priceElement.textContent = `‚Ç¨${color.price.toFixed(2)}`;
              console.log(`üí∞ Preisanzeige aktualisiert: ‚Ç¨${color.price.toFixed(2)}`);
            }
            
            // Aktualisiere Warenkorb-Gesamtsumme
            setTimeout(() => {
              if (typeof updateCartDisplay === 'function') {
                updateCartDisplay();
                console.log('üîÑ Warenkorb-Gesamtsumme aktualisiert');
              }
            }, 200);
          }

          const imgElement = cartItem?.querySelector(".cart-item-image");
          if (imgElement) {
            const newImagePath = getColorSpecificImagePath(product, colorName);
            imgElement.src = newImagePath;
            console.log('üñºÔ∏è Hauptbild aktualisiert auf:', newImagePath);
          }
          
          // Aktualisiere nur das Hauptproduktbild, NICHT die Farbauswahl-Thumbnails
          setTimeout(() => {
            const mainImages = cartItem?.querySelectorAll('.cart-item-image');
            mainImages?.forEach(img => {
              const correctPath = getColorSpecificImagePath(product, colorName);
              img.src = correctPath;
              console.log('üîÑ Hauptbild aktualisiert auf:', correctPath);
            });
          }, 100);
        }
      });
    });

    const oldSelection = container.querySelector(".cart-item-color-selection");
    if (oldSelection) oldSelection.remove();
    container.appendChild(selectionContainer);

    // WICHTIG: Setze das initiale Hauptbild UND Produktname basierend auf der aktuell ausgew√§hlten Farbe
    const cartItem = container.closest(".cart-item");
    const mainImage = cartItem?.querySelector(".cart-item-image, img");
    const nameElement = cartItem?.querySelector("h5, .cart-item-name, .product-name");
    
    if (mainImage && currentColor) {
      const initialImagePath = getColorSpecificImagePath(product, currentColor);
      mainImage.src = initialImagePath;
      console.log('üéØ INITIALES Hauptbild gesetzt f√ºr Farbe', currentColor, ':', initialImagePath);
    }
    
    if (nameElement && currentColor) {
      // Aktualisiere auch den Produktnamen mit der Farbe
      let baseName = product.name.replace(/\s*\([^)]*\)$/, '');
      const newName = `${baseName} (${currentColor})`;
      nameElement.textContent = newName;
      console.log('üìù INITIALER Produktname gesetzt:', newName);
      
      // Aktualisiere auch den localStorage
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const itemIndex = cart.findIndex((cartItem) => cartItem.id == item.id);
      if (itemIndex !== -1) {
        cart[itemIndex].name = newName;
        cart[itemIndex].selectedColor = currentColor;
        localStorage.setItem("cart", JSON.stringify(cart));
        console.log('üíæ Warenkorb aktualisiert mit Farbe:', currentColor);
      }
    }
  } catch (error) {
    console.error("Fehler beim Rendern der Farbauswahl:", error);
  }
}

function extractColorFromName(name) {
  const match = name.match(/\(([^)]+)\)$/);
  return match ? match[1] : null;
}

function getColorSpecificImagePath(product, colorName) {
  console.log('üñºÔ∏è GLOBALER getColorSpecificImagePath f√ºr Produkt', product.id, 'Farbe:', colorName);
  
  // GLOBALER ANSATZ: Verwende immer die Farb-Daten aus products.json
  if (product.colors && Array.isArray(product.colors)) {
    const colorData = product.colors.find((c) => c.name === colorName);
    if (colorData && colorData.image) {
      console.log('‚úÖ Globale Farb-Daten gefunden:', colorData.image);
      return colorData.image;
    }
  }

  console.log('‚ö†Ô∏è Fallback zum Hauptbild:', product.image);
  return product.image;
}

function initCartColorSelection() {
  const cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
  const cartItemElements = document.querySelectorAll(".cart-item");

  cartItemElements.forEach((element, index) => {
    const itemData = cartItems[index];
    if (itemData) {
      if (!element.querySelector(".cart-item-color-selection")) {
        renderImageColorSelection(itemData, element);
      }
    }
  });
}

// Funktion zum Korrigieren aller Hauptbilder UND Produktnamen basierend auf Farben
async function fixAllCartImages() {
  try {
    const response = await fetch("products.json");
    const products = await response.json();
    const cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
    let cartUpdated = false;
    
    document.querySelectorAll(".cart-item").forEach((cartElement, index) => {
      const cartItem = cartItems[index];
      if (!cartItem) return;
      
      const currentColor = extractColorFromName(cartItem.name);
      const product = products.find(p => p.id === parseInt(cartItem.id));
      
      if (product) {
        // Korrigiere das Hauptbild
        const mainImage = cartElement.querySelector(".cart-item-image, img");
        if (mainImage && currentColor) {
          const correctImagePath = getColorSpecificImagePath(product, currentColor);
          mainImage.src = correctImagePath;
          console.log('üîß Bild korrigiert f√ºr', cartItem.name, ':', correctImagePath);
        }
        
        // Korrigiere den Produktnamen falls n√∂tig
        const nameElement = cartElement.querySelector("h5, .cart-item-name, .product-name");
        if (nameElement && product.colors && product.colors.length > 0) {
          let shouldUpdateName = false;
          let newName = cartItem.name;
          
          // Wenn keine Farbe im Namen, aber Produkt hat Farben -> erste Farbe hinzuf√ºgen
          if (!currentColor) {
            const firstColor = product.colors[0].name;
            newName = `${product.name} (${firstColor})`;
            shouldUpdateName = true;
            console.log('üé® Erste Farbe hinzugef√ºgt:', newName);
          }
          // Wenn Farbe im Namen, aber Name nicht korrekt formatiert
          else if (!cartItem.name.includes(`(${currentColor})`)) {
            const baseName = product.name.replace(/\s*\([^)]*\)$/, '');
            newName = `${baseName} (${currentColor})`;
            shouldUpdateName = true;
            console.log('üìù Produktname korrigiert:', newName);
          }
          
          if (shouldUpdateName) {
            nameElement.textContent = newName;
            cartItems[index].name = newName;
            cartItems[index].selectedColor = currentColor || product.colors[0].name;
            cartUpdated = true;
          }
        }
      }
    });
    
    // Speichere aktualisierte Warenkorb-Daten
    if (cartUpdated) {
      localStorage.setItem("cart", JSON.stringify(cartItems));
      console.log('üíæ Warenkorb global aktualisiert');
    }
  } catch (error) {
    console.error('‚ùå Fehler beim Korrigieren der Bilder und Namen:', error);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const observer = new MutationObserver(() => {
    const cartContent = document.getElementById("cartContent");
    if (cartContent && cartContent.querySelector(".cart-item")) {
      initCartColorSelection();
      // Zus√§tzlich: Korrigiere alle Bilder
      setTimeout(fixAllCartImages, 500);
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
  setTimeout(() => {
    initCartColorSelection();
    fixAllCartImages();
  }, 1000);
});
